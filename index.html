<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular SimTower</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #f0f0f0; overflow: hidden; }
        #gameContainer { display: flex; height: 100vh; }
        #canvasContainer { flex: 1; background: #000; position: relative; overflow: auto; }
        #gameCanvas { display: block; image-rendering: pixelated; cursor: crosshair; }
        
        #sidebar { width: 280px; background: #252525; padding: 15px; display: flex; flex-direction: column; border-left: 1px solid #444; }
        
        #hud { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #555; }
        .hud-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #ccc; }
        .hud-value { font-size: 18px; font-weight: 700; color: #fff; font-family: 'Lucida Console', monospace; }
        #money { color: #81C784; }
        #rating { color: #FFD54F; }

        #controls { overflow-y: auto; flex: 1; }
        .btn { 
            width: 100%; padding: 12px 15px; margin-bottom: 8px; border: 1px solid transparent; border-radius: 6px;
            cursor: pointer; color: #e0e0e0; text-align: left; font-weight: 600; font-size: 13px;
            background: #4a4a4a; transition: all 0.2s;
        }
        .btn:hover { background: #5a5a5a; border-color: #777; }
        .btn.active { background: #1976D2; border-color: #42A5F5; }
        .btn.disabled { background: #383838; color: #777; cursor: not-allowed; }
        .btn.speed { font-weight: bold; }
        .btn.pause { background: #D32F2F; }
        .btn.pause:hover { background: #F44336; }
        
        .tool-cost { font-size: 11px; float: right; color: #bbb; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="canvasContainer">
            <canvas id="gameCanvas"></canvas>
        </div>
        <div id="sidebar">
            <div id="hud">
                <div class="hud-item"><span>Money</span><span id="money">$2,000,000</span></div>
                <div class="hud-item"><span>Time</span><span id="time">06:00</span></div>
                <div class="hud-item"><span>Day</span><span id="day">1</span></div>
                <div class="hud-item"><span>Population</span><span id="population">0</span></div>
                <div class="hud-item"><span>Rating</span><span id="rating">★</span></div>
            </div>
            <div id="controls">
                <button class="btn speed" id="speedBtn" onclick="toggleSpeed()">Speed: 1x</button>
                <button class="btn pause" onclick="togglePause()">Pause</button>
                <hr style="margin: 10px 0; border-color: #444;">
                <div id="buildTools"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { TowerEngine, CONFIG, TYPES, ROOM_PROPS } from './Engine.js';
        import { GridManager } from './GridManager.js';
        import { SimulationManager } from './SimulationManager.js';
        import { SystemsManager } from './SystemsManager.js';

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = CONFIG.GRID_W * CONFIG.CELL_SIZE;
        canvas.height = CONFIG.GRID_H * CONFIG.CELL_SIZE;

        const gridMgr = new GridManager();
        gridMgr.initCanvas(canvas.width, canvas.height);

        const engine = new TowerEngine();
        const simMgr = new SimulationManager();
        const sysMgr = new SystemsManager();

        let currentTool = null;

        const allTools = [
            { label: 'Lobby', type: 'LOBBY' }, { label: 'Stairs', type: 'STAIRS' },
            { label: 'Elevator', type: 'ELEVATOR' }, { label: 'Express Elev', type: 'ELEVATOR_EXPRESS' },
            { label: 'Service Elev', type: 'ELEVATOR_SERVICE' }, { label: 'Office', type: 'OFFICE' },
            { label: 'Condo', type: 'CONDO' }, { label: 'Hotel', type: 'HOTEL' },
            { label: 'Food Court', type: 'FOOD' }, { label: 'Cinema', type: 'CINEMA' },
            { label: 'Security', type: 'SECURITY' }, { label: 'Cleaning', type: 'CLEANING_SERVICE' },
            { label: 'Parking', type: 'PARKING' }, { label: 'Medical', type: 'MEDICAL' },
            { label: 'Recycling', type: 'RECYCLING' }, { label: 'Metro', type: 'METRO' },
            { label: 'Cathedral', type: 'CATHEDRAL' }, { label: 'Demolish', type: 'DEMOLISH' }
        ];

        function generateBuildButtons() {
            const container = document.getElementById('buildTools');
            container.innerHTML = ''; // Clear existing buttons
            allTools.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                const typeId = TYPES[t.type];
                const isBuildable = engine.buildable.has(typeId) || t.type === 'DEMOLISH';

                if (!isBuildable) btn.classList.add('disabled');

                let cost = '';
                if (t.type !== 'DEMOLISH' && ROOM_PROPS[typeId]) {
                    cost = `$${ROOM_PROPS[typeId].cost.toLocaleString()}`;
                }
                btn.innerHTML = `${t.label} <span class="tool-cost">${cost}</span>`;

                btn.onclick = () => {
                    if (!isBuildable) return;
                    document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                    currentTool = (currentTool === t.type) ? null : t.type;
                    if (currentTool) btn.classList.add('active');
                };
                container.appendChild(btn);
            });
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!currentTool) return;
            const rect = canvas.getBoundingClientRect();
            const gx = Math.floor((e.clientX - rect.left) / CONFIG.CELL_SIZE);
            const gy = Math.floor((e.clientY - rect.top) / CONFIG.CELL_SIZE);

            if (gx < 0 || gx >= CONFIG.GRID_W || gy < 0 || gy >= CONFIG.GRID_H) return;

            if (currentTool === 'DEMOLISH') {
                if(gridMgr.demolish(gx, gy)) {
                    // Cost can be added here
                }
            } else {
                const typeId = TYPES[currentTool];
                const cost = ROOM_PROPS[typeId].cost;
                if (engine.money >= cost) {
                    if (gridMgr.build(gx, gy, typeId, engine)) {
                        engine.money -= cost;
                    }
                } else {
                    alert("Not enough money!");
                }
            }
            gridMgr.checkConnectivity();
            sysMgr.syncElevators(gridMgr.grid);
        });

        function collectDailyIncome() {
            let totalIncome = 0;
            for (let y = 0; y < CONFIG.GRID_H; y++) {
                for (let x = 0; x < CONFIG.GRID_W; x++) {
                    const cell = gridMgr.grid[y][x];
                    if (cell.isAnchor && cell.connected) {
                        switch(cell.type) {
                            case TYPES.OFFICE: totalIncome += CONFIG.OFFICE_RENT * cell.width; break;
                            case TYPES.HOTEL:  totalIncome += CONFIG.HOTEL_RENT * cell.width; break; // Simplified
                            case TYPES.PARKING:totalIncome += CONFIG.PARKING_INCOME; break;
                        }
                    }
                }
            }
            engine.money += totalIncome;
        }

        // Global Functions
        window.toggleSpeed = () => {
            document.getElementById('speedBtn').innerText = `Speed: ${engine.setSpeed()}x`;
        };
        window.togglePause = () => {
            engine.togglePause();
            document.querySelector('.btn.pause').innerText = engine.paused ? 'Resume' : 'Pause';
        };

        // Main Loop
        let lastTime = performance.now();
        function loop() {
            const now = performance.now();
            const dt = (now - lastTime) / 1000 * 60; // Normalize dt
            lastTime = now;

            const newDay = engine.update(dt);
            if (newDay) {
                collectDailyIncome();
            }

            gridMgr.updateDirt();
            gridMgr.updateStress();
            
            simMgr.update(dt, engine.speed, gridMgr.grid, sysMgr.elevators, engine.time);
            sysMgr.update(simMgr.people);

            // Draw calls
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const isNight = engine.isNight();
            gridMgr.draw(ctx, isNight);
            if (isNight) {
                ctx.fillStyle = 'rgba(0, 0, 40, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            sysMgr.draw(ctx);
            simMgr.draw(ctx);

            // Update UI
            document.getElementById('money').innerText = `$${Math.floor(engine.money).toLocaleString()}`;
            document.getElementById('time').innerText = engine.getFormattedTime();
            document.getElementById('day').innerText = engine.day;
            document.getElementById('population').innerText = simMgr.getTotalPopulation();
            const oldRating = document.getElementById('rating').innerText.length;
            if (engine.rating !== oldRating) {
                document.getElementById('rating').innerText = '★'.repeat(engine.rating);
                generateBuildButtons(); // Re-generate buttons on rating change
            }

            requestAnimationFrame(loop);
        }

        generateBuildButtons();
        requestAnimationFrame(loop);
    </script>
</body>
</html>
