<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular SimTower</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #f0f0f0; overflow: hidden; }
        #gameContainer { display: flex; height: 100vh; }
        #canvasContainer { flex: 1; background: #000; }
        #gameCanvas { display: block; image-rendering: pixelated; cursor: crosshair; }
        
        #sidebar { width: 280px; background: #252525; padding: 15px; display: flex; flex-direction: column; border-left: 1px solid #444; }
        
        #hud { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #555; }
        .hud-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #ccc; }
        .hud-value { font-size: 18px; font-weight: 700; color: #fff; font-family: 'Lucida Console', monospace; }
        #money { color: #81C784; }
        #rating { color: #FFD54F; }

        #controls { overflow-y: auto; flex: 1; }
        .btn { 
            width: 100%; padding: 12px 15px; margin-bottom: 8px; border: 1px solid transparent; border-radius: 6px;
            cursor: pointer; color: #e0e0e0; text-align: left; font-weight: 600; font-size: 13px;
            background: #4a4a4a; transition: all 0.2s;
        }
        .btn:hover { background: #5a5a5a; border-color: #777; }
        .btn.active { background: #03A9F4; color: #fff; border-color: #03A9F4; }
        
        .btn-clean, .btn-demolish, .btn-speed { margin-top: 15px; background: #3c3c3c; border: 1px solid #666; }
        .btn-clean.active { background: #00BCD4; border-color: #00BCD4;}
        .btn-demolish.active { background: #f44336; border-color: #f44336; }
        
        #message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #222; color: white; padding: 12px 25px; border-radius: 6px; display: none; font-weight: bold; border: 1px solid #555; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="canvasContainer"><canvas id="gameCanvas"></canvas></div>
        <div id="sidebar">
            <div id="hud">
                <div class="hud-item">Money <span class="hud-value" id="money">$0</span></div>
                <div class="hud-item">Pop <span class="hud-value" id="population">0</span></div>
                <div class="hud-item">Time <span class="hud-value" id="time">08:00</span></div>
                <div class="hud-item">Day <span class="hud-value" id="day">1</span></div>
                <div class="hud-item">Rating <span class="hud-value" id="rating">★</span></div>
            </div>
            <div id="controls">
                <button class="btn btn-office" onclick="setMode('office')">Office ($8k)</button>
                <button class="btn btn-condo" onclick="setMode('condo')">Condo ($15k)</button>
                <button class="btn btn-hotel" onclick="setMode('hotel')">Hotel ($12k)</button>
                <button class="btn btn-food" onclick="setMode('food')">Fast Food ($10k)</button>
                <button class="btn btn-parking" onclick="setMode('parking')">Parking ($5k)</button>
                <button class="btn btn-stairs" onclick="setMode('stairs')">Stairs ($1k)</button>
                <button class="btn btn-elevator" onclick="setMode('elevator')">Elevator ($5k)</button>
                <button class="btn btn-clean" onclick="setMode('clean')">Clean / Maintain</button>
                <button class="btn btn-demolish" onclick="setMode('demolish')">Demolish</button>
                <button class="btn btn-speed" onclick="toggleSpeed()">Speed: <span id="speedLabel">1x</span></button>
            </div>
        </div>
    </div>
    <div id="message"></div>

    <script type="module">
        import { CONFIG, TYPES, ROOM_PROPS, TowerEngine, beep } from './Engine.js';
        import { GridManager } from './GridManager.js';
        import { SystemsManager } from './SystemsManager.js';
        import { SimulationManager } from './SimulationManager.js';

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const engine = new TowerEngine();
        const gridMgr = new GridManager();
        const sysMgr = new SystemsManager();
        const simMgr = new SimulationManager();
        let buildMode = null;

        function resize() {
            canvas.width = CONFIG.GRID_W * CONFIG.CELL_SIZE;
            canvas.height = CONFIG.GRID_H * CONFIG.CELL_SIZE;
            gridMgr.initCanvas(canvas.width, canvas.height);
        }
        resize();

        window.setMode = (mode) => { buildMode = mode; document.querySelectorAll('.btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); };
        window.toggleSpeed = () => { document.getElementById('speedLabel').innerText = engine.setSpeed() + 'x'; };
        function showMessage(msg) { const el = document.getElementById('message'); el.innerText = msg; el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 3000); }

        function collectOfficeIncome() {
            let total = 0;
            for (let y = 0; y < CONFIG.GRID_H; y++) {
                for (let x = 0; x < CONFIG.GRID_W; x++) {
                    const c = gridMgr.grid[y][x];
                    if (c.isAnchor && c.connected && c.type === TYPES.OFFICE && c.stress < 80 && c.dirt < 80) {
                        total += CONFIG.OFFICE_RENT;
                    }
                }
            }
            engine.money += total;
            if (total > 0) showMessage(`Office Rent: $${total.toLocaleString()}`);
        }

        function collectHotelIncome() {
            let total = 0;
            for (let y = 0; y < CONFIG.GRID_H; y++) {
                for (let x = 0; x < CONFIG.GRID_W; x++) {
                    const c = gridMgr.grid[y][x];
                    if (c.isAnchor && c.connected && c.type === TYPES.HOTEL && c.stress < 80 && c.dirt < 80) {
                        total += CONFIG.HOTEL_RENT * Math.min(c.occupants.length, 3);
                    }
                }
            }
            engine.money += total;
            if (total > 0) showMessage(`Hotel Fees: $${total.toLocaleString()}`);
        }

        function collectOtherIncome() {
            let total = 0;
            for (let y = 0; y < CONFIG.GRID_H; y++) {
                for (let x = 0; x < CONFIG.GRID_W; x++) {
                    const c = gridMgr.grid[y][x];
                    if (!c.isAnchor || !c.connected) continue;
                    if (c.stress > 80 || c.dirt > 80) continue;

                    if (c.type === TYPES.FOOD) total += CONFIG.FOOD_INCOME_PER * c.occupants.length;
                    if (c.type === TYPES.PARKING) total += CONFIG.PARKING_INCOME;
                }
            }
            engine.money += total;
            if (total > 0) showMessage(`Daily Income: $${total.toLocaleString()}`);
        }

        canvas.addEventListener('click', e => {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / CONFIG.CELL_SIZE);
            const y = Math.floor((e.clientY - rect.top) / CONFIG.CELL_SIZE);
            
            // Clean Mode Logic
            if (buildMode === 'clean') { gridMgr.cleanRoom(x, y); return; }
            if (buildMode === 'demolish') { 
                if(gridMgr.demolish(x, y)) { gridMgr.checkConnectivity(); sysMgr.syncElevators(gridMgr.grid); }
                return; 
            }

            if (!buildMode) return;
            
            // Determine Type
            let type = 0;
            switch(buildMode) {
                case 'office': type = TYPES.OFFICE; break;
                case 'condo': type = TYPES.CONDO; break;
                case 'hotel': type = TYPES.HOTEL; break;
                case 'food': type = TYPES.FOOD; break;
                case 'stairs': type = TYPES.STAIRS; break;
                case 'elevator': type = TYPES.ELEVATOR; break;
                case 'parking': type = TYPES.PARKING; break;
            }
            
            const props = ROOM_PROPS[type];
            if (!props) return;

            if (engine.money >= props.cost) {
                if (gridMgr.build(x, y, type)) {
                    engine.money -= props.cost;
                    if (type === TYPES.CONDO) engine.money += CONFIG.CONDO_SALE;
                    gridMgr.checkConnectivity();
                    sysMgr.syncElevators(gridMgr.grid);
                } else {
                    showMessage("Can't build there!");
                }
            } else showMessage("Not enough funds!");
        });

        let lastTime = 0;
        let collectedOffice = false;
        let collectedHotel = false;

        function loop(ts) {
            const dt = ts - lastTime || 16;
            lastTime = ts;
            const newDay = engine.update(dt);

            if (newDay) {
                collectOtherIncome();
                collectedOffice = false;
                collectedHotel = false;
            }

            if (engine.time >= 17 * 60 && !collectedOffice) {
                collectOfficeIncome();
                collectedOffice = true;
            }
            if (engine.time >= 6 * 60 && !collectedHotel) {
                collectHotelIncome();
                collectedHotel = true;
            }
            
            gridMgr.updateDirt();
            gridMgr.updateStress();
            
            simMgr.update(dt, engine.speed, gridMgr.grid, sysMgr.elevators, engine.time);
            sysMgr.update(simMgr.people);

            ctx.clearRect(0,0, canvas.width, canvas.height);
            const isNight = engine.isNight();
            gridMgr.draw(ctx, isNight, engine);
            sysMgr.draw(ctx);
            simMgr.draw(ctx);
            
            if (isNight) { ctx.fillStyle = 'rgba(0,0,30,0.3)'; ctx.fillRect(0,0,canvas.width, canvas.height); }

            let totalPop = simMgr.getTotalPopulation(gridMgr.grid);
            engine.updateRating(totalPop);

            document.getElementById('money').innerText = `$${Math.floor(engine.money).toLocaleString()}`;
            document.getElementById('time').innerText = engine.getFormattedTime();
            document.getElementById('day').innerText = engine.day;
            document.getElementById('population').innerText = totalPop;
            document.getElementById('rating').innerText = '★'.repeat(engine.rating);
            requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);
    </script>
</body>
</html>
